<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARCHIVIO ‚Äî Sistema Ricerca Catalogo</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --ibm-blue: #0f62fe;
            --ibm-blue-dark: #002d9c;
            --ibm-blue-light: #4589ff;
            --ibm-gray-100: #f4f4f4;
            --ibm-gray-90: #e0e0e0;
            --ibm-gray-80: #c6c6c6;
            --ibm-gray-60: #8d8d8d;
            --ibm-gray-30: #393939;
            --ibm-gray-20: #262626;
            --ibm-gray-10: #161616;
            --ibm-warm: #f7f3f2;
            --terminal-green: #42be65;
            --artist-color: #8a3ffc;
            --author-color: #007d79;
            --title-color: #da1e28;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Sans', -apple-system, sans-serif;
            background-color: var(--ibm-gray-100);
            color: var(--ibm-gray-10);
            min-height: 100vh;
            line-height: 1.5;
            display: flex;
            flex-direction: column;
        }

        /* Top stripe */
        .top-stripe {
            height: 8px;
            background: repeating-linear-gradient(
                90deg,
                var(--ibm-blue) 0px,
                var(--ibm-blue) 40px,
                var(--ibm-gray-10) 40px,
                var(--ibm-gray-10) 80px
            );
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1.5rem;
            width: 100%;
        }

        /* Header */
        header {
            background: var(--ibm-gray-10);
            padding: 1.5rem 0;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-stripes {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .logo-stripes span {
            display: block;
            width: 30px;
            height: 3px;
            background: var(--ibm-blue);
        }

        h1 {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--ibm-gray-100);
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .system-info {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--ibm-gray-60);
            text-align: right;
        }

        .system-info .status {
            color: var(--terminal-green);
        }

        /* Main chat area */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem 0;
        }

        /* Chat container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 1rem;
        }

        /* Messages */
        .message {
            margin-bottom: 1rem;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
            display: flex;
            justify-content: flex-end;
        }

        .message-user .message-content {
            background: var(--ibm-blue);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px 12px 0 12px;
            max-width: 70%;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9rem;
        }

        .message-user .message-content.direct-artist {
            background: var(--artist-color);
        }

        .message-user .message-content.direct-author {
            background: var(--author-color);
        }

        .message-user .message-content.direct-title {
            background: var(--title-color);
        }

        .message-user .message-content.has-image {
            background: var(--terminal-green);
        }

        .message-bot {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .message-bot .message-content {
            background: white;
            border: 1px solid var(--ibm-gray-80);
            padding: 1rem 1.25rem;
            border-radius: 12px 12px 12px 0;
            max-width: 85%;
            font-size: 0.95rem;
            line-height: 1.7;
        }

        .message-bot .message-content a {
            color: var(--ibm-blue);
            text-decoration: none;
            border-bottom: 1px solid var(--ibm-blue-light);
        }

        .message-bot .message-content a:hover {
            color: var(--ibm-blue-dark);
        }

        /* Results section in direct search */
        .results-section {
            margin-top: 1rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--ibm-gray-90);
        }

        .results-count {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            color: var(--ibm-gray-60);
        }

        .results-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .control-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
            color: var(--ibm-gray-60);
            text-transform: uppercase;
        }

        .control-select {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--ibm-gray-80);
            background: white;
            color: var(--ibm-gray-30);
            border-radius: 3px;
            cursor: pointer;
        }

        .control-select:hover {
            border-color: var(--ibm-blue);
        }

        /* Grouped results */
        .results-group {
            margin-bottom: 1rem;
        }

        .results-group-header {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--ibm-gray-30);
            background: var(--ibm-gray-90);
            padding: 0.4rem 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
        }

        .results-group-header:hover {
            background: var(--ibm-gray-80);
        }

        .results-group-header .count {
            color: var(--ibm-gray-60);
        }

        .results-group-content {
            padding-left: 0.5rem;
        }

        .results-group-content.collapsed {
            display: none;
        }

        /* Results list (compact) */
        .result-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--ibm-gray-90);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item-img {
            width: 50px;
            height: 65px;
            object-fit: cover;
            background: var(--ibm-gray-90);
            flex-shrink: 0;
            border-radius: 2px;
        }

        .result-item-info {
            flex: 1;
            min-width: 0;
        }

        .result-item-title {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.15rem;
        }

        .result-item-title a {
            color: var(--ibm-gray-10);
            text-decoration: none;
        }

        .result-item-title a:hover {
            color: var(--ibm-blue);
        }

        .result-item-meta {
            font-size: 0.7rem;
            color: var(--ibm-gray-60);
        }

        .result-item-type {
            display: inline-block;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.6rem;
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            margin-left: 0.5rem;
            text-transform: uppercase;
        }

        .result-item-type.monografia {
            background: #d4edda;
            color: #155724;
        }

        .result-item-type.collettiva {
            background: #cce5ff;
            color: #004085;
        }

        .result-item-type.autore {
            background: #fff3cd;
            color: #856404;
        }

        .result-item-type.menzione {
            background: var(--ibm-gray-90);
            color: var(--ibm-gray-60);
        }

        /* Results preview in message (for AI search) */
        .results-preview {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--ibm-gray-90);
        }

        .results-preview-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--ibm-gray-60);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .results-mini-grid {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .result-mini-card {
            flex-shrink: 0;
            width: 100px;
            background: var(--ibm-gray-100);
            border: 1px solid var(--ibm-gray-90);
            border-radius: 4px;
            overflow: hidden;
            text-decoration: none;
            color: inherit;
            transition: border-color 0.15s;
        }

        .result-mini-card:hover {
            border-color: var(--ibm-blue);
        }

        .result-mini-img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            background: var(--ibm-gray-90);
        }

        .result-mini-title {
            padding: 0.4rem;
            font-size: 0.65rem;
            line-height: 1.3;
            color: var(--ibm-gray-30);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .show-all-btn {
            display: inline-block;
            margin-top: 0.75rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--ibm-blue);
            background: none;
            border: 1px solid var(--ibm-blue);
            padding: 0.4rem 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .show-all-btn:hover {
            background: var(--ibm-blue);
            color: white;
        }

        /* Filter buttons */
        .filter-buttons {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--ibm-gray-90);
        }

        .filter-buttons-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--ibm-gray-60);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .filter-buttons-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .filter-btn {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--ibm-gray-80);
            background: white;
            color: var(--ibm-gray-30);
            cursor: pointer;
            transition: all 0.15s;
            border-radius: 3px;
        }

        .filter-btn:hover {
            border-color: var(--ibm-blue);
            color: var(--ibm-blue);
        }

        .filter-btn.active {
            background: var(--ibm-blue);
            border-color: var(--ibm-blue);
            color: white;
        }

        .filter-btn .count {
            opacity: 0.7;
            margin-left: 0.3rem;
        }

        /* Full results modal */
        .results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .results-modal.visible {
            display: block;
        }

        .results-modal-content {
            background: var(--ibm-gray-100);
            max-width: 1000px;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
        }

        .results-modal-header {
            background: var(--ibm-gray-10);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-modal-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .results-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .results-modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
        }

        .result-card {
            background: white;
            border: 1px solid var(--ibm-gray-80);
            overflow: hidden;
        }

        .result-card-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: var(--ibm-gray-90);
        }

        .result-card-body {
            padding: 0.75rem;
        }

        .result-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }

        .result-card-title a {
            color: var(--ibm-gray-10);
            text-decoration: none;
        }

        .result-card-title a:hover {
            color: var(--ibm-blue);
        }

        .result-card-meta {
            font-size: 0.7rem;
            color: var(--ibm-gray-60);
        }

        /* Input area */
        .input-area {
            background: white;
            border-top: 1px solid var(--ibm-gray-80);
            padding: 1rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-box {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.875rem 1rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.95rem;
            border: 2px solid var(--ibm-gray-30);
            background: var(--ibm-gray-100);
            color: var(--ibm-gray-10);
            outline: none;
            border-radius: 4px;
        }

        .chat-input:focus {
            border-color: var(--ibm-blue);
        }

        .chat-input::placeholder {
            color: var(--ibm-gray-60);
        }

        .chat-input.mode-artist {
            border-color: var(--artist-color);
        }

        .chat-input.mode-author {
            border-color: var(--author-color);
        }

        .chat-input.mode-title {
            border-color: var(--title-color);
        }

        .chat-input.mode-image {
            border-color: var(--terminal-green);
        }

        /* Camera button */
        .camera-btn {
            padding: 0.875rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            background: transparent;
            border: 2px solid var(--ibm-gray-30);
            color: var(--ibm-gray-30);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-btn:hover {
            border-color: var(--terminal-green);
            color: var(--terminal-green);
        }

        .camera-btn.has-image {
            border-color: var(--terminal-green);
            background: var(--terminal-green);
            color: white;
        }

        .camera-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Image preview */
        .image-preview-container {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--ibm-gray-100);
            border: 1px solid var(--terminal-green);
            border-radius: 4px;
        }

        .image-preview-container.visible {
            display: flex;
        }

        .image-preview-thumb {
            width: 50px;
            height: 65px;
            object-fit: cover;
            border-radius: 2px;
            border: 1px solid var(--ibm-gray-80);
        }

        .image-preview-info {
            flex: 1;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            color: var(--terminal-green);
        }

        .image-preview-remove {
            background: none;
            border: none;
            color: var(--ibm-gray-60);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
            line-height: 1;
        }

        .image-preview-remove:hover {
            color: var(--title-color);
        }

        .send-btn {
            padding: 0.875rem 1.5rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            background: var(--ibm-blue);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.15s;
        }

        .send-btn:hover {
            background: var(--ibm-blue-dark);
        }

        .send-btn:disabled {
            background: var(--ibm-gray-60);
            cursor: not-allowed;
        }

        /* Autocomplete dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 70px;
            background: white;
            border: 1px solid var(--ibm-gray-80);
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .autocomplete-dropdown.visible {
            display: block;
        }

        .autocomplete-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--ibm-gray-100);
        }

        .autocomplete-item .type-badge {
            font-size: 0.6rem;
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            text-transform: uppercase;
        }

        .autocomplete-item .type-badge.artist {
            background: var(--artist-color);
            color: white;
        }

        .autocomplete-item .type-badge.author {
            background: var(--author-color);
            color: white;
        }

        .autocomplete-item .match-highlight {
            background: #fff3cd;
        }

        .input-hint {
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .hint-text {
            font-size: 0.7rem;
            color: var(--ibm-gray-60);
        }

        .hint-syntax {
            display: flex;
            gap: 1rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.65rem;
        }

        .hint-syntax span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .hint-syntax .prefix {
            font-weight: 600;
        }

        .hint-syntax .prefix.artist { color: var(--artist-color); }
        .hint-syntax .prefix.author { color: var(--author-color); }
        .hint-syntax .prefix.title { color: var(--title-color); }
        .hint-syntax .prefix.image { color: var(--terminal-green); }

        .new-search-btn {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            color: var(--ibm-blue);
            background: none;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .new-search-btn:hover {
            text-decoration: underline;
        }

        /* Welcome message */
        .welcome-message {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--ibm-gray-60);
        }

        .welcome-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .welcome-message p {
            font-size: 0.9rem;
            max-width: 400px;
            margin: 0 auto 1rem;
        }

        .welcome-examples {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .welcome-example {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            padding: 0.4rem 0.75rem;
            background: white;
            border: 1px solid var(--ibm-gray-80);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .welcome-example:hover {
            border-color: var(--ibm-blue);
            color: var(--ibm-blue);
        }

        .welcome-example.artist {
            border-color: var(--artist-color);
            color: var(--artist-color);
        }

        .welcome-example.author {
            border-color: var(--author-color);
            color: var(--author-color);
        }

        .welcome-example.title {
            border-color: var(--title-color);
            color: var(--title-color);
        }

        .welcome-example.image {
            border-color: var(--terminal-green);
            color: var(--terminal-green);
        }

        /* Loading */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--ibm-gray-60);
            border-radius: 50%;
            animation: typing 1s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Message with image thumbnail */
        .message-image-thumb {
            width: 40px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .message-user .message-content,
            .message-bot .message-content {
                max-width: 90%;
            }

            .results-modal {
                padding: 1rem;
            }

            .results-modal-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .hint-syntax {
                display: none;
            }

            .results-controls {
                flex-wrap: wrap;
            }

            .camera-btn {
                padding: 0.875rem 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="top-stripe"></div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-stripes">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <h1>Archivio</h1>
                </div>
                <div class="system-info">
                    Catalogo libri d'arte<br>
                    <span class="status">‚óè Online</span>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="chat-container" id="chatContainer">
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-icon">[ ]</div>
                    <p>Cerca un artista, un tema o chiedi un consiglio. Usa i prefissi per ricerche dirette, o scatta una foto a una copertina.</p>
                    <div class="welcome-examples">
                        <button class="welcome-example artist" onclick="setExample('@Bruce Nauman')">@Bruce Nauman</button>
                        <button class="welcome-example author" onclick="setExample('#Germano Celant')">#Germano Celant</button>
                        <button class="welcome-example title" onclick="setExample('&quot;When attitudes become form&quot')">"When attitudes..."</button>
                        <button class="welcome-example" onclick="setExample('fotografia giapponese')">fotografia giapponese</button>
                        <button class="welcome-example image" onclick="triggerImageUpload()">üì∑ Foto copertina</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="input-area">
        <div class="container">
            <!-- Image preview -->
            <div class="image-preview-container" id="imagePreviewContainer">
                <img id="imagePreviewThumb" class="image-preview-thumb" src="" alt="Preview">
                <div class="image-preview-info">
                    üì∑ Foto copertina allegata
                </div>
                <button class="image-preview-remove" id="removeImageBtn" title="Rimuovi immagine">&times;</button>
            </div>
            
            <div class="input-wrapper">
                <div class="input-box">
                    <!-- Hidden file input -->
                    <input type="file" id="imageInput" accept="image/*" capture="environment" style="display: none;">
                    
                    <!-- Camera button -->
                    <button class="camera-btn" id="cameraBtn" title="Cerca con foto copertina">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                            <circle cx="12" cy="13" r="4"/>
                        </svg>
                    </button>
                    
                    <input 
                        type="text" 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Scrivi qui o scatta una foto..."
                        autocomplete="off"
                        autofocus
                    >
                    <button class="send-btn" id="sendBtn">Invia</button>
                </div>
                <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
            </div>
            <div class="input-hint">
                <div class="hint-syntax">
                    <span><span class="prefix artist">@</span> artista</span>
                    <span><span class="prefix author">#</span> autore</span>
                    <span><span class="prefix title">"..."</span> titolo</span>
                    <span><span class="prefix image">üì∑</span> foto</span>
                </div>
                <button class="new-search-btn" id="newSearchBtn">Nuova ricerca</button>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="results-modal" id="resultsModal">
        <div class="results-modal-content">
            <div class="results-modal-header">
                <span class="results-modal-title">Tutti i risultati</span>
                <button class="results-modal-close" id="closeModal">&times;</button>
            </div>
            <div class="results-modal-grid" id="resultsModalGrid"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api/search';
        const SUGGEST_URL = '/api/suggest';
        const BOOK_URL = 'https://test01-frontend.vercel.app/books';
        
        // Conversation context
        let conversationContext = {
            lastSearch: null,
            lastResults: [],
            lastFilters: {},
            searchType: null  // 'direct-artist', 'direct-author', 'direct-title', 'ai', 'image'
        };

        // Autocomplete state
        let autocompleteData = [];
        let selectedAutocompleteIndex = -1;
        let autocompleteTimeout = null;

        // Image state
        let selectedImageBase64 = null;

        const chatContainer = document.getElementById('chatContainer');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const newSearchBtn = document.getElementById('newSearchBtn');
        const resultsModal = document.getElementById('resultsModal');
        const resultsModalGrid = document.getElementById('resultsModalGrid');
        const closeModal = document.getElementById('closeModal');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        
        // Image elements
        const imageInput = document.getElementById('imageInput');
        const cameraBtn = document.getElementById('cameraBtn');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreviewThumb = document.getElementById('imagePreviewThumb');
        const removeImageBtn = document.getElementById('removeImageBtn');

        // ============ IMAGE HANDLING ============

        function triggerImageUpload() {
            imageInput.click();
        }

        cameraBtn.addEventListener('click', triggerImageUpload);

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Immagine troppo grande. Massimo 5MB.');
                return;
            }

            // Convert to base64
            const base64 = await fileToBase64(file);
            selectedImageBase64 = base64;

            // Show preview
            imagePreviewThumb.src = base64;
            imagePreviewContainer.classList.add('visible');
            cameraBtn.classList.add('has-image');
            chatInput.classList.add('mode-image');
            chatInput.placeholder = 'Aggiungi una nota (opzionale)...';
            chatInput.focus();
        });

        removeImageBtn.addEventListener('click', clearImage);

        function clearImage() {
            selectedImageBase64 = null;
            imageInput.value = '';
            imagePreviewContainer.classList.remove('visible');
            cameraBtn.classList.remove('has-image');
            chatInput.classList.remove('mode-image');
            chatInput.placeholder = 'Scrivi qui o scatta una foto...';
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ============ QUERY PARSING ============

        function parseQuery(query) {
            query = query.trim();
            
            // @artista
            if (query.startsWith('@')) {
                return {
                    type: 'artist',
                    value: query.slice(1).trim(),
                    display: query
                };
            }
            
            // #autore
            if (query.startsWith('#')) {
                return {
                    type: 'author',
                    value: query.slice(1).trim(),
                    display: query
                };
            }
            
            // "titolo" o ¬´titolo¬ª
            const titleMatch = query.match(/^["¬´](.+?)["¬ª]$/);
            if (titleMatch) {
                return {
                    type: 'title',
                    value: titleMatch[1].trim(),
                    display: query
                };
            }
            
            // Ricerca AI normale
            return {
                type: 'ai',
                value: query,
                display: query
            };
        }

        function getInputMode() {
            const value = chatInput.value;
            if (selectedImageBase64) return 'image';
            if (value.startsWith('@')) return 'artist';
            if (value.startsWith('#')) return 'author';
            if (value.startsWith('"') || value.startsWith('¬´')) return 'title';
            return null;
        }

        function updateInputStyle() {
            const mode = getInputMode();
            chatInput.classList.remove('mode-artist', 'mode-author', 'mode-title', 'mode-image');
            if (mode) {
                chatInput.classList.add(`mode-${mode}`);
            }
        }

        // ============ AUTOCOMPLETE ============

        async function fetchSuggestions(type, query) {
            if (query.length < 2) {
                hideAutocomplete();
                return;
            }

            try {
                const response = await fetch(`${SUGGEST_URL}?type=${type}&q=${encodeURIComponent(query)}`);
                if (!response.ok) return;
                
                const data = await response.json();
                if (data.suggestions && data.suggestions.length > 0) {
                    autocompleteData = data.suggestions.map(s => ({
                        name: s,
                        type: type
                    }));
                    showAutocomplete();
                } else {
                    hideAutocomplete();
                }
            } catch (e) {
                console.error('Autocomplete error:', e);
                hideAutocomplete();
            }
        }

        function showAutocomplete() {
            if (autocompleteData.length === 0) {
                hideAutocomplete();
                return;
            }

            const query = chatInput.value.slice(1).toLowerCase(); // Remove prefix
            
            autocompleteDropdown.innerHTML = autocompleteData.map((item, index) => {
                const highlighted = highlightMatch(item.name, query);
                return `
                    <div class="autocomplete-item ${index === selectedAutocompleteIndex ? 'selected' : ''}" 
                         data-index="${index}">
                        <span class="type-badge ${item.type}">${item.type === 'artist' ? 'ART' : 'AUT'}</span>
                        <span>${highlighted}</span>
                    </div>
                `;
            }).join('');
            
            autocompleteDropdown.classList.add('visible');
        }

        function hideAutocomplete() {
            autocompleteDropdown.classList.remove('visible');
            autocompleteData = [];
            selectedAutocompleteIndex = -1;
        }

        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="match-highlight">$1</span>');
        }

        function selectAutocomplete(index) {
            if (index < 0 || index >= autocompleteData.length) return;
            
            const item = autocompleteData[index];
            const prefix = item.type === 'artist' ? '@' : '#';
            chatInput.value = prefix + item.name;
            hideAutocomplete();
            chatInput.focus();
        }

        // ============ MESSAGES ============

        function addMessage(content, isUser = false, data = null) {
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'message-user' : 'message-bot'}`;

            let contentClass = '';
            if (isUser && data?.searchType) {
                contentClass = `direct-${data.searchType}`;
            }
            if (isUser && data?.hasImage) {
                contentClass = 'has-image';
            }

            let html = `<div class="message-content ${contentClass}">`;
            
            // Add image thumbnail for user messages with images
            if (isUser && data?.imageThumb) {
                html += `<img src="${data.imageThumb}" class="message-image-thumb" alt="Copertina">`;
            }
            
            html += content;

            // For direct searches, show sortable results
            if (!isUser && data && data.tipo_ricerca === 'diretto' && data.risultati) {
                html += renderDirectResults(data.risultati, data);
            }
            // For AI name searches, show filter buttons
            else if (!isUser && data && data.filtri_disponibili && data.tipo_ricerca === 'nome') {
                html += renderFilterButtons(data);
                html += renderResultsPreview(data.risultati);
            }
            // For semantic searches, show suggestions and preview
            else if (!isUser && data && data.tipo_ricerca === 'semantica') {
                if (data.suggerimenti && data.suggerimenti.length > 0) {
                    html += renderSuggestionButtons(data.suggerimenti);
                }
                html += renderResultsPreview(data.risultati);
            }
            // Other searches with results
            else if (!isUser && data && data.risultati && data.risultati.length > 0) {
                html += renderResultsPreview(data.risultati);
            }

            html += '</div>';
            messageDiv.innerHTML = html;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Attach event listeners for sorting/grouping
            if (!isUser && data && data.tipo_ricerca === 'diretto') {
                attachSortingListeners(messageDiv, data.risultati);
            }
        }

        function renderDirectResults(results, data) {
            const searchedName = data.nome_cercato || data.titolo_cercato || '';
            
            let html = `
                <div class="results-section">
                    <div class="results-header">
                        <span class="results-count">${results.length} risultati per "${searchedName}"</span>
                        <div class="results-controls">
                            <div class="control-group">
                                <span class="control-label">Ordina:</span>
                                <select class="control-select sort-select">
                                    <option value="relevance">Rilevanza</option>
                                    <option value="year-desc">Anno ‚Üì</option>
                                    <option value="year-asc">Anno ‚Üë</option>
                                    <option value="title">Titolo A-Z</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <span class="control-label">Raggruppa:</span>
                                <select class="control-select group-select">
                                    <option value="none">Nessuno</option>
                                    <option value="decade">Per decennio</option>
                                    <option value="language">Per lingua</option>
                                    <option value="type">Per tipo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="results-list">
                        ${renderResultsList(results)}
                    </div>
                </div>
            `;
            return html;
        }

        function renderResultsList(results, groupBy = 'none') {
            if (groupBy === 'none') {
                return results.slice(0, 30).map(book => renderResultItem(book)).join('');
            }

            // Group results
            const groups = {};
            results.forEach(book => {
                let key;
                switch(groupBy) {
                    case 'decade':
                        const year = parseInt(book.anno) || 0;
                        const decade = Math.floor(year / 10) * 10;
                        key = decade ? `Anni ${decade.toString().slice(-2)}` : 'Anno sconosciuto';
                        break;
                    case 'language':
                        key = normalizeLanguage(book.lingua) || 'Lingua n.d.';
                        break;
                    case 'type':
                        key = getTypeLabel(book.tipo);
                        break;
                    default:
                        key = 'Tutti';
                }
                if (!groups[key]) groups[key] = [];
                groups[key].push(book);
            });

            // Sort groups
            const sortedKeys = Object.keys(groups).sort((a, b) => {
                if (groupBy === 'decade') {
                    return b.localeCompare(a); // Newest first
                }
                return groups[b].length - groups[a].length; // Most items first
            });

            return sortedKeys.map(key => `
                <div class="results-group" data-group="${key}">
                    <div class="results-group-header" onclick="toggleGroup(this)">
                        <span>${key}</span>
                        <span class="count">(${groups[key].length})</span>
                    </div>
                    <div class="results-group-content">
                        ${groups[key].slice(0, 20).map(book => renderResultItem(book)).join('')}
                        ${groups[key].length > 20 ? `<div class="result-item" style="text-align:center;color:var(--ibm-gray-60)">...e altri ${groups[key].length - 20}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderResultItem(book) {
            const typeClass = book.tipo || 'menzione';
            const typeLabel = getTypeLabel(book.tipo);
            
            return `
                <div class="result-item">
                    <img src="${book.immagine || ''}" alt="" class="result-item-img" 
                         onerror="this.style.background='var(--ibm-gray-90)';this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22/>'">
                    <div class="result-item-info">
                        <div class="result-item-title">
                            <a href="${BOOK_URL}/${book.id}" target="_blank">${book.titolo || 'Senza titolo'}</a>
                            ${typeLabel ? `<span class="result-item-type ${typeClass}">${typeLabel}</span>` : ''}
                        </div>
                        <div class="result-item-meta">
                            ${book.editore || ''} ${book.anno || ''} ¬∑ ${normalizeLanguage(book.lingua) || ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFilterButtons(data) {
            const filters = data.filtri_disponibili;
            let html = `<div class="filter-buttons">`;
            html += `<div class="filter-buttons-label">Filtra risultati:</div>`;
            
            // Type buttons
            if (filters.tipi) {
                html += `<div class="filter-buttons-row">`;
                if (filters.tipi.monografia > 0) {
                    html += `<button class="filter-btn" onclick="applyFilter('tipo_pub', 'monografia')">Monografie <span class="count">(${filters.tipi.monografia})</span></button>`;
                }
                if (filters.tipi.collettiva > 0) {
                    html += `<button class="filter-btn" onclick="applyFilter('tipo_pub', 'collettiva')">Collettive <span class="count">(${filters.tipi.collettiva})</span></button>`;
                }
                if (filters.tipi.autore > 0) {
                    html += `<button class="filter-btn" onclick="applyFilter('tipo_pub', 'autore')">Come autore <span class="count">(${filters.tipi.autore})</span></button>`;
                }
                html += `</div>`;
            }
            
            // Language buttons
            if (filters.lingue && Object.keys(filters.lingue).length > 1) {
                html += `<div class="filter-buttons-row">`;
                const langNames = {'IT': 'Italiano', 'EN': 'English', 'DE': 'Deutsch', 'FR': 'Fran√ßais', 'ES': 'Espa√±ol'};
                for (const [lang, count] of Object.entries(filters.lingue).slice(0, 5)) {
                    const langName = langNames[lang] || lang;
                    html += `<button class="filter-btn" onclick="applyFilter('lingua', '${lang}')">${langName} <span class="count">(${count})</span></button>`;
                }
                html += `</div>`;
            }
            
            html += `</div>`;
            return html;
        }

        function renderSuggestionButtons(suggestions) {
            window.currentSuggestions = suggestions;
            let html = `<div class="filter-buttons">`;
            html += `<div class="filter-buttons-label">Affina la ricerca:</div>`;
            html += `<div class="filter-buttons-row">`;
            suggestions.forEach((suggestion, index) => {
                html += `<button class="filter-btn suggestion-btn" data-suggestion-index="${index}">${suggestion}</button>`;
            });
            html += `</div></div>`;
            return html;
        }

        function renderResultsPreview(results) {
            if (!results || results.length === 0) return '';
            
            return `
                <div class="results-preview">
                    <div class="results-preview-title">${results.length} risultati trovati</div>
                    <div class="results-mini-grid">
                        ${results.slice(0, 5).map(book => `
                            <a href="${BOOK_URL}/${book.id}" target="_blank" class="result-mini-card">
                                <img src="${book.immagine || ''}" alt="" class="result-mini-img" onerror="this.style.display='none'">
                                <div class="result-mini-title">${truncate(book.titolo, 50)}</div>
                            </a>
                        `).join('')}
                    </div>
                    ${results.length > 5 ? `<button class="show-all-btn" onclick="showAllResults()">Mostra tutti (${results.length})</button>` : ''}
                </div>
            `;
        }

        // ============ SORTING & GROUPING ============

        function attachSortingListeners(messageDiv, originalResults) {
            const sortSelect = messageDiv.querySelector('.sort-select');
            const groupSelect = messageDiv.querySelector('.group-select');
            const resultsList = messageDiv.querySelector('.results-list');

            if (!sortSelect || !groupSelect || !resultsList) return;

            let currentResults = [...originalResults];

            function updateResults() {
                const sortBy = sortSelect.value;
                const groupBy = groupSelect.value;

                // Sort
                let sorted = [...originalResults];
                switch(sortBy) {
                    case 'year-desc':
                        sorted.sort((a, b) => (parseInt(b.anno) || 0) - (parseInt(a.anno) || 0));
                        break;
                    case 'year-asc':
                        sorted.sort((a, b) => (parseInt(a.anno) || 0) - (parseInt(b.anno) || 0));
                        break;
                    case 'title':
                        sorted.sort((a, b) => (a.titolo || '').localeCompare(b.titolo || ''));
                        break;
                    // 'relevance' keeps original order
                }

                currentResults = sorted;
                resultsList.innerHTML = renderResultsList(sorted, groupBy);
            }

            sortSelect.addEventListener('change', updateResults);
            groupSelect.addEventListener('change', updateResults);
        }

        function toggleGroup(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('collapsed');
        }

        // ============ UTILITIES ============

        function normalizeLanguage(lang) {
            if (!lang) return '';
            const upper = lang.trim().toUpperCase();
            const map = {
                'I': 'IT', 'ITA': 'IT', 'ITALIANO': 'IT',
                'E': 'EN', 'ENG': 'EN', 'ENGLISH': 'EN',
                'D': 'DE', 'DEU': 'DE', 'DEUTSCH': 'DE',
                'F': 'FR', 'FRA': 'FR', 'FRANCAIS': 'FR',
                'FRAN√áAIS': 'FR'
            };
            return map[upper] || upper;
        }

        function getTypeLabel(tipo) {
            const labels = {
                'monografia_titolo': 'Monografia',
                'monografia': 'Monografia',
                'collettiva': 'Collettiva',
                'autore': 'Come autore',
                'menzione': 'Citazione'
            };
            return labels[tipo] || '';
        }

        function truncate(text, length) {
            if (!text) return '';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        // ============ SEARCH FUNCTIONS ============

        async function sendMessage() {
            const rawQuery = chatInput.value.trim();
            const hasImage = !!selectedImageBase64;
            
            // Allow sending with just an image (no text required)
            if (!rawQuery && !hasImage) return;

            const parsed = parseQuery(rawQuery);
            hideAutocomplete();

            // Build display text
            let displayText = parsed.display || '';
            if (hasImage && !displayText) {
                displayText = 'üì∑ Cerca per copertina';
            } else if (hasImage) {
                displayText = 'üì∑ ' + displayText;
            }

            // Add user message
            addMessage(displayText, true, { 
                searchType: hasImage ? 'image' : (parsed.type !== 'ai' ? parsed.type : null),
                hasImage: hasImage,
                imageThumb: hasImage ? selectedImageBase64 : null
            });
            
            chatInput.value = '';
            chatInput.classList.remove('mode-artist', 'mode-author', 'mode-title', 'mode-image');
            sendBtn.disabled = true;

            addTypingIndicator();

            try {
                let response, data;

                if (parsed.type === 'artist' || parsed.type === 'author') {
                    // Direct search - skip AI, just SQL
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: parsed.value,
                            searchType: parsed.type,  // 'artist' o 'author'
                            limit: 100,
                            direct: true
                        })
                    });
                    
                    data = await response.json();
                    data.tipo_ricerca = 'diretto';
                    
                    // Generate simple response text
                    const count = data.risultati?.length || 0;
                    const typeText = parsed.type === 'artist' ? 'artista' : 'autore';
                    data.risposta = count > 0 
                        ? `${count} risultati per ${typeText} "${parsed.value}".`
                        : `Nessun risultato per ${typeText} "${parsed.value}".`;

                } else if (parsed.type === 'title') {
                    // Title search
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: parsed.value,
                            searchType: 'title',
                            limit: 50,
                            direct: true
                        })
                    });
                    
                    data = await response.json();
                    data.tipo_ricerca = 'diretto';
                    
                    const count = data.risultati?.length || 0;
                    data.risposta = count > 0 
                        ? `${count} risultati per titolo "${parsed.value}".`
                        : `Nessun libro trovato con titolo "${parsed.value}".`;

                } else {
                    // AI semantic search (with optional image)
                    const requestBody = {
                        query: parsed.value,
                        limit: 50
                    };

                    // Add image if present
                    if (hasImage) {
                        requestBody.image = selectedImageBase64;
                    }

                    if (conversationContext.lastSearch) {
                        requestBody.context = {
                            previousSearch: conversationContext.lastSearch,
                            previousFilters: conversationContext.lastFilters
                        };
                    }

                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    data = await response.json();
                }

                if (data.error) throw new Error(data.error);

                // Update context
                conversationContext.lastSearch = data.nome_cercato || data.titolo_cercato || parsed.value;
                conversationContext.lastResults = data.risultati || [];
                conversationContext.lastFilters = data.filtri || {};
                conversationContext.searchType = hasImage ? 'image' : parsed.type;

                removeTypingIndicator();
                addMessage(data.risposta, false, data);

            } catch (error) {
                removeTypingIndicator();
                addMessage('Mi dispiace, c\'√® stato un errore. Riprova.', false);
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
                chatInput.focus();
                
                // Clear image after sending
                if (hasImage) {
                    clearImage();
                }
            }
        }

        async function applyFilter(filterType, filterValue) {
            if (!conversationContext.lastSearch) return;
            
            conversationContext.lastFilters[filterType] = filterValue;
            
            const filterNames = {
                'tipo_pub': {'monografia': 'solo monografie', 'collettiva': 'solo collettive', 'autore': 'come autore'},
                'lingua': {'IT': 'in italiano', 'EN': 'in inglese', 'DE': 'in tedesco', 'FR': 'in francese'}
            };
            const filterText = filterNames[filterType]?.[filterValue] || `${filterType}: ${filterValue}`;
            addMessage(filterText, true);
            
            addTypingIndicator();
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: conversationContext.lastSearch,
                        limit: 50,
                        filters: conversationContext.lastFilters
                    })
                });
                
                const data = await response.json();
                conversationContext.lastResults = data.risultati || [];
                
                removeTypingIndicator();
                addMessage(data.risposta, false, data);
                
            } catch (error) {
                removeTypingIndicator();
                addMessage('Errore nell\'applicare il filtro.', false);
            }
        }

        async function applySuggestion(suggestion) {
            addMessage(suggestion, true);
            addTypingIndicator();
            
            const combinedQuery = suggestion + ' ' + conversationContext.lastSearch;
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: combinedQuery,
                        mode: 'refined',
                        originalQuery: conversationContext.lastSearch,
                        refinement: suggestion,
                        limit: 50
                    })
                });
                
                const data = await response.json();
                
                conversationContext.lastSearch = combinedQuery;
                conversationContext.lastResults = data.risultati || [];
                
                removeTypingIndicator();
                addMessage(data.risposta, false, data);
                
            } catch (error) {
                removeTypingIndicator();
                addMessage('Errore nella ricerca.', false);
            }
        }

        // ============ UI HELPERS ============

        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message message-bot';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }

        function showAllResults() {
            if (conversationContext.lastResults.length === 0) return;

            resultsModalGrid.innerHTML = conversationContext.lastResults.map(book => `
                <div class="result-card">
                    <img src="${book.immagine || ''}" alt="" class="result-card-img" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e0e0e0%22 width=%22100%22 height=%22100%22/></svg>'">
                    <div class="result-card-body">
                        <div class="result-card-title">
                            <a href="${BOOK_URL}/${book.id}" target="_blank">${book.titolo || 'Senza titolo'}</a>
                        </div>
                        <div class="result-card-meta">${book.editore || ''} ${book.anno || ''}</div>
                    </div>
                </div>
            `).join('');

            resultsModal.classList.add('visible');
        }

        function resetConversation() {
            conversationContext = {
                lastSearch: null,
                lastResults: [],
                lastFilters: {},
                searchType: null
            };
            clearImage();
            chatContainer.innerHTML = `
                <div class="welcome-message" id="welcomeMessage">
                    <div class="welcome-icon">[ ]</div>
                    <p>Cerca un artista, un tema o chiedi un consiglio. Usa i prefissi per ricerche dirette, o scatta una foto a una copertina.</p>
                    <div class="welcome-examples">
                        <button class="welcome-example artist" onclick="setExample('@Bruce Nauman')">@Bruce Nauman</button>
                        <button class="welcome-example author" onclick="setExample('#Germano Celant')">#Germano Celant</button>
                        <button class="welcome-example title" onclick="setExample('&quot;When attitudes become form&quot')">"When attitudes..."</button>
                        <button class="welcome-example" onclick="setExample('fotografia giapponese')">fotografia giapponese</button>
                        <button class="welcome-example image" onclick="triggerImageUpload()">üì∑ Foto copertina</button>
                    </div>
                </div>
            `;
        }

        function setExample(text) {
            chatInput.value = text;
            chatInput.focus();
            updateInputStyle();
        }

        // ============ EVENT LISTENERS ============

        sendBtn.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keydown', (e) => {
            // Handle autocomplete navigation
            if (autocompleteDropdown.classList.contains('visible')) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, autocompleteData.length - 1);
                    showAutocomplete();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, 0);
                    showAutocomplete();
                } else if (e.key === 'Enter' && selectedAutocompleteIndex >= 0) {
                    e.preventDefault();
                    selectAutocomplete(selectedAutocompleteIndex);
                    return;
                } else if (e.key === 'Escape') {
                    hideAutocomplete();
                    return;
                }
            }
            
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        chatInput.addEventListener('input', () => {
            updateInputStyle();
            
            // Trigger autocomplete for @ and #
            const value = chatInput.value;
            const mode = getInputMode();
            
            if (mode === 'artist' || mode === 'author') {
                const query = value.slice(1); // Remove prefix
                
                clearTimeout(autocompleteTimeout);
                autocompleteTimeout = setTimeout(() => {
                    fetchSuggestions(mode === 'artist' ? 'artist' : 'author', query);
                }, 150);
            } else {
                hideAutocomplete();
            }
        });

        chatInput.addEventListener('blur', () => {
            // Delay to allow click on autocomplete
            setTimeout(hideAutocomplete, 200);
        });

        autocompleteDropdown.addEventListener('click', (e) => {
            const item = e.target.closest('.autocomplete-item');
            if (item) {
                selectAutocomplete(parseInt(item.dataset.index));
            }
        });

        newSearchBtn.addEventListener('click', resetConversation);
        
        closeModal.addEventListener('click', () => {
            resultsModal.classList.remove('visible');
        });
        
        resultsModal.addEventListener('click', (e) => {
            if (e.target === resultsModal) {
                resultsModal.classList.remove('visible');
            }
        });
        
        // Event delegation for suggestion buttons
        chatContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('suggestion-btn')) {
                const index = e.target.dataset.suggestionIndex;
                if (window.currentSuggestions && window.currentSuggestions[index]) {
                    applySuggestion(window.currentSuggestions[index]);
                }
            }
        });

        // Make functions global for onclick
        window.toggleGroup = toggleGroup;
        window.setExample = setExample;
        window.applyFilter = applyFilter;
        window.showAllResults = showAllResults;
        window.triggerImageUpload = triggerImageUpload;
    </script>
</body>
</html>
